services:
  # User Service
  user_svc:
    build:
      context: ./apps/user_svc
      dockerfile: Dockerfile
      args:
        ELIXIR_IMAGE: hexpm/elixir:1.19.2-erlang-28.1-alpine-3.22.2

    container_name: msvc-user-svc
    ports:
      - "8081:8081"
    environment:
      # Application config
      PORT: "8081"
      MIX_ENV: "prod"

      # Service URLs (use Docker service names)
      USER_SVC_URL: "http://user_svc:8081"
      JOB_SVC_URL: "http://job_svc:8082"
      CLIENT_SVC_URL: "http://client_svc:4000"

      # MinIO config
      MINIO_ACCESS_KEY: "minioadmin"
      MINIO_SECRET_KEY: "minioadmin"
      MINIO_SCHEME: "http://"
      MINIO_HOST: "minio"
      MINIO_PORT: "9000"
      AWS_REGION: "us-east-1"

      # OpenTelemetry config
      OTEL_SERVICE_NAME: "user_svc"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"

      # Logging config
      LOG_LEVEL: "info"
      # LOG_FORMAT: "json"  # Uncomment for JSON logs

      # Docker Loki logging driver - no sidecar needed!
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-batch-size: "400"
        loki-retries: "3"
        labels: "service,environment"
        loki-external-labels: "service=user_svc,environment=dev"

    depends_on:
      - minio
      - jaeger
      - loki
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8081/health" ]
      interval: 30s
      timeout: 3s
      retries: 3

  # Client Service
  # client_svc:
  #   build:
  #     context: ./apps/client_svc
  #     dockerfile: Dockerfile
  #     args:
  #       ELIXIR_IMAGE: hexpm/elixir:1.19.2-erlang-28.1-alpine-3.22.2

  #   container_name: msvc-client-svc
  #   ports:
  #     - "4000:4000"
  #   environment:
  #     # Application config
  #     PORT: "4000"
  #     MIX_ENV: "prod"

  #     # Service URLs (use Docker service names)
  #     USER_SVC_URL: "http://user_svc:8081"

  #     # OpenTelemetry config
  #     OTEL_SERVICE_NAME: "client_svc"
  #     OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"

  #     # Logging config
  #     LOG_LEVEL: "info"
  #     # LOG_FORMAT: "json"  # Uncomment for JSON logs

  #   # Docker Loki logging driver
  #   logging:
  #     driver: loki
  #     options:
  #       loki-url: "http://localhost:3100/loki/api/v1/push"
  #       loki-batch-size: "400"
  #       loki-retries: "3"
  #       labels: "service,environment"
  #       loki-external-labels: "service=client_svc,environment=dev"

  #   depends_on:
  #     - user_svc
  #     - jaeger
  #     - loki
  #   healthcheck:
  #     test: [ "CMD", "wget", "-q", "--spider", "http://localhost:4000/health" ]
  #     interval: 30s
  #     timeout: 3s
  #     retries: 3

  # Job Service
  job_svc:
    build:
      context: ./apps/job_svc
      dockerfile: Dockerfile
      args:
        ELIXIR_IMAGE: hexpm/elixir:1.19.2-erlang-28.1-alpine-3.22.2

    container_name: msvc-job-svc
    ports:
      - "8082:8082"
    environment:
      # Application config
      PORT: "8082"
      MIX_ENV: "prod"

      # Service URLs (use Docker service names)
      IMAGE_SVC_URL: "http://image_svc:8084"
      EMAIL_SVC_URL: "http://email_svc:8083"
      USER_SVC_URL: "http://user_svc:8081"

      # OpenTelemetry config
      OTEL_SERVICE_NAME: "job_svc"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"

      # Logging config
      LOG_LEVEL: "info"
      # LOG_FORMAT: "json"  # Uncomment for JSON logs

      # Database config (SQLite for Oban)
      DATABASE_PATH: "/app/db/job_service.db"
      DB_POOL_SIZE: "5"

    # Docker Loki logging driver
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-batch-size: "400"
        loki-retries: "3"
        labels: "service,environment"
        loki-external-labels: "service=job_svc,environment=dev"

    volumes:
      - job-data:/app/db  # Persist SQLite database

    depends_on:
      - jaeger
      - loki
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8082/health" ]
      interval: 30s
      timeout: 3s
      retries: 3

  # Image Service
  image_svc:
    build:
      context: ./apps/image_svc
      dockerfile: Dockerfile
      args:
        ELIXIR_IMAGE: hexpm/elixir:1.19.2-erlang-28.1-alpine-3.22.2

    container_name: msvc-image-svc
    ports:
      - "8084:8084"
    environment:
      # Application config
      PORT: "8084"
      MIX_ENV: "prod"

      # Service URLs (use Docker service names)
      USER_SVC_URL: "http://user_svc:8081"

      # MinIO config
      MINIO_ACCESS_KEY: "minioadmin"
      MINIO_SECRET_KEY: "minioadmin"
      MINIO_SCHEME: "http://"
      MINIO_HOST: "minio"
      MINIO_PORT: "9000"
      AWS_REGION: "us-east-1"

      # OpenTelemetry config
      OTEL_SERVICE_NAME: "image_svc"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"

      # Logging config
      LOG_LEVEL: "info"
      # LOG_FORMAT: "json"  # Uncomment for JSON logs

      # Docker Loki logging driver
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-batch-size: "400"
        loki-retries: "3"
        labels: "service,environment"
        loki-external-labels: "service=image_svc,environment=dev"

    depends_on:
      - minio
      - jaeger
      - loki
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8084/health" ]
      interval: 30s
      timeout: 3s
      retries: 3

  # Email Service
  email_svc:
    build:
      context: ./apps/email_svc
      dockerfile: Dockerfile
      args:
        ELIXIR_IMAGE: hexpm/elixir:1.19.2-erlang-28.1-alpine-3.22.2

    container_name: msvc-email-svc
    ports:
      - "8083:8083"
    environment:
      # Application config
      PORT: "8083"
      MIX_ENV: "prod"

      # OpenTelemetry config
      OTEL_SERVICE_NAME: "email_svc"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://jaeger:4318"

      # Logging config
      LOG_LEVEL: "info"
      # LOG_FORMAT: "json"  # Uncomment for JSON logs

      # Mailer config (Local adapter - no SMTP needed!)
      MAILER_ADAPTER: "local"

    # Docker Loki logging driver
    logging:
      driver: loki
      options:
        loki-url: "http://localhost:3100/loki/api/v1/push"
        loki-batch-size: "400"
        loki-retries: "3"
        labels: "service,environment"
        loki-external-labels: "service=email_svc,environment=dev"

    depends_on:
      - jaeger
      - loki
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8083/health" ]
      interval: 30s
      timeout: 3s
      retries: 3

  minio:
    image: minio/minio:latest
    container_name: msvc-minio
    ports:
      - "9000:9000" # API port
      - "9001:9001" # Console UI port
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3

  # zipkin:
  #   image: openzipkin/zipkin-slim
  #   container_name: msvc-zipkin
  #   environment:
  #     - STORAGE_TYPE=mem
  #   ports:
  #     - '9411:9411'
  jaeger:
    image: jaegertracing/jaeger:latest
    container_name: msvc-jaeger
    ports:
      - "16686:16686" # Jaeger UI
      - "4318:4318" # OTLP HTTP receiver (for OpenTelemetry)
      - "4317:4317" # OTLP gRPC receiver (alternative)
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - LOG_LEVEL=debug
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:16686" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Loki - Log aggregation (like Prometheus but for logs)
  loki:
    image: grafana/loki:latest
    container_name: msvc-loki
    ports:
      - "3100:3100" # Loki API
    command: -config.file=/etc/loki/config.yml
    volumes:
      - ./loki/config.yml:/etc/loki/config.yml # Mount custom config with MinIO
      - loki-data:/loki
    depends_on:
      - minio # Loki stores data in MinIO
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3100/ready" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Promtail - Log shipper (reads logs and sends to Loki)
  # promtail:
  #   image: grafana/promtail:latest
  #   container_name: msvc-promtail
  #   ports:
  #     - "9080:9080" # Promtail HTTP
  #   volumes:
  #     - ./promtail/config.yml:/etc/promtail/config.yml
  #     - ./logs:/var/log/elixir # Mount logs directory
  #   command: -config.file=/etc/promtail/config.yml
  #   depends_on:
  #     - loki

  # Grafana - Visualization for logs AND metrics
  grafana:
    image: grafana/grafana:latest
    container_name: msvc-grafana
    ports:
      - "3000:3000" # Grafana UI
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - loki
      - jaeger
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  minio-data:
    driver: local
  loki-data:
    driver: local
  grafana-data:
    driver: local
  job-data:
    driver: local
