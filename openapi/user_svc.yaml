openapi: 3.1.0
info:
  title: User Service API
  description: User management service handling user creation, email workflows, and image conversion coordination
  version: 1.0.0
servers:
  - url: http://localhost:8081
    description: Local development
  - url: http://user_svc:8081
    description: User service server (Docker)

paths:
  /user_svc/create_user/v1:
    post:
      summary: Create user and trigger email workflow
      operationId: createUser
      tags:
        - user-management
      description: |
        Creates a user and enqueues a welcome/notification email via job_svc.

        **Caller**: client_svc/Client.create
        **Receiver**: user_svc/CreateUserController.create

        This endpoint receives UserRequest, forwards it to job_svc for email processing, and returns acknowledgment.
      requestBody:
        required: true
        content:
          application/protobuf:
            schema:
              type: object
              description: UserRequest protobuf message
              properties:
                id:
                  type: string
                  description: User ID
                name:
                  type: string
                  description: User full name
                email:
                  type: string
                  format: email
                  description: User email address
                type:
                  type: string
                  enum: [EMAIL_TYPE_WELCOME, EMAIL_TYPE_NOTIFICATION]
                  description: Type of email to send
              required:
                - id
                - name
                - email
                - type
            example:
              id: "user123"
              name: "John Doe"
              email: "john.doe@example.com"
              type: "EMAIL_TYPE_WELCOME"
      responses:
        "200":
          description: User created and email job enqueued successfully
          content:
            application/protobuf:
              schema:
                type: object
                description: UserResponse protobuf message
                properties:
                  ok:
                    type: boolean
                    description: Success indicator
                  message:
                    type: string
                    description: Status message
        "500":
          description: Failed to process user creation
          content:
            text/plain:
              schema:
                type: string

  /user_svc/notify_email_sent/v1:
    post:
      summary: Receive email delivery notification from job_svc
      operationId: notifyEmailSent
      tags:
        - notifications
      description: |
        Receives email delivery status notifications from job_svc after email is sent.

        **Caller**: job_svc/UserSvcClient.notify_email_sent
        **Receiver**: user_svc/ForwardEmailNotificationController.forward

        This endpoint decodes the EmailResponse protobuf and forwards it to client_svc.
      requestBody:
        required: true
        content:
          application/protobuf:
            schema:
              type: object
              description: EmailResponse protobuf message
              properties:
                user_id:
                  type: string
                  description: User ID who received the email
                email:
                  type: string
                  format: email
                  description: Recipient email address
                success:
                  type: boolean
                  description: Whether email was delivered successfully
                message:
                  type: string
                  description: Status message or error details
              required:
                - user_id
                - email
                - success
                - message
            example:
              user_id: "user123"
              email: "john.doe@example.com"
              success: true
              message: "Email sent successfully to john.doe@example.com"
      responses:
        "204":
          description: Notification received and forwarded to client_svc successfully
        "422":
          description: Failed to decode EmailResponse protobuf
          content:
            text/plain:
              schema:
                type: string
                example: "[User][ForwardEmailNotificationController] Failed: :decode_error"

  /user_svc/convert_image/v1:
    post:
      summary: Initiate image-to-PDF conversion workflow
      operationId: convertImage
      tags:
        - image-processing
      description: |
        Receives image data from client, stores it temporarily, and forwards conversion request to job_svc.

        **Caller**: client_svc/ImageClient.convert_png
        **Receiver**: user_svc/ConvertImageController.convert

        Flow:
        1. Stores image with generated storage_id
        2. Creates presigned URL for image access
        3. Forwards conversion job to job_svc
        4. Returns acknowledgment to client
      requestBody:
        required: true
        content:
          application/protobuf:
            schema:
              type: object
              description: ImageConversionRequest protobuf message
              properties:
                user_id:
                  type: string
                  description: User ID
                user_email:
                  type: string
                  format: email
                  description: User email for notification
                image_data:
                  type: string
                  format: binary
                  description: Raw image binary data
                input_format:
                  type: string
                  enum: [png, jpeg, jpg]
                  description: Input image format
                pdf_quality:
                  type: string
                  enum: [low, medium, high, lossless]
                  description: PDF quality setting
                strip_metadata:
                  type: boolean
                  description: Whether to remove EXIF metadata
                max_width:
                  type: integer
                  description: Maximum width (0 for no limit)
                max_height:
                  type: integer
                  description: Maximum height (0 for no limit)
              required:
                - user_id
                - user_email
                - image_data
                - input_format
            example:
              user_id: "user123"
              user_email: "user@example.com"
              image_data: "<base64-encoded-image-data>"
              input_format: "png"
              pdf_quality: "high"
              strip_metadata: true
              max_width: 0
              max_height: 0
      responses:
        "200":
          description: Conversion job enqueued successfully
          content:
            application/protobuf:
              schema:
                type: object
                description: UserResponse protobuf message
                properties:
                  ok:
                    type: boolean
                    description: Success indicator
                  message:
                    type: string
                    description: Status message
        "500":
          description: Failed to process conversion request
          content:
            application/protobuf:
              schema:
                type: object
                description: UserResponse protobuf with error
                properties:
                  ok:
                    type: boolean
                  message:
                    type: string

  /user_svc/image_loader/v1/{job_id}:
    get:
      summary: Serve stored images to other services
      operationId: loadImage
      tags:
        - storage-retrieval
      description: |
        Serves temporarily stored images to other services (primarily image_svc for conversion).

        **Caller**: image_svc/ConversionController.fetch_image (via Req.get)
        **Receiver**: user_svc/ImageLoaderController.load

        The image is identified by storage_id (job_id), and the response content-type is determined by file extension.
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: string
          description: Storage ID for the stored image (e.g., "timestamp_random.png")
          example: "1234567890_abc123.png"
      responses:
        "200":
          description: Image binary data with appropriate content-type
          content:
            image/png:
              schema:
                type: string
                format: binary
            image/jpeg:
              schema:
                type: string
                format: binary
            image/gif:
              schema:
                type: string
                format: binary
            application/octet-stream:
              schema:
                type: string
                format: binary
                description: Fallback for unknown formats
          headers:
            Content-Length:
              description: Size of the image in bytes
              schema:
                type: integer
        "404":
          description: Image not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "[User] Image not found"

  /user_svc/notify_image_converted/v1:
    post:
      summary: Receive image conversion completion notification from job_svc
      operationId: notifyImageConverted
      tags:
        - notifications
      description: |
        Receives notification from job_svc after image-to-PDF conversion is complete.

        **Caller**: job_svc/ImageSvcClient.convert_image (line 51)
        **Receiver**: user_svc/NotifyImageConvertedController.forward

        This endpoint decodes the ImageConversionResponse protobuf and forwards it to client_svc.
      requestBody:
        required: true
        content:
          application/protobuf:
            schema:
              type: object
              description: ImageConversionResponse protobuf message
              properties:
                success:
                  type: boolean
                  description: Whether conversion was successful
                message:
                  type: string
                  description: Status message
                user_email:
                  type: string
                  format: email
                  description: Email of user who initiated conversion
                storage_id:
                  type: string
                  description: PDF storage ID in MinIO
                pdf_url:
                  type: string
                  description: Presigned URL to access the PDF
                output_size:
                  type: integer
                  format: int64
                  description: PDF file size in bytes
                width:
                  type: integer
                  description: PDF width in pixels
                height:
                  type: integer
                  description: PDF height in pixels
                original_storage_id:
                  type: string
                  description: Original PNG storage ID (for cleanup)
              required:
                - success
                - message
                - user_email
                - storage_id
                - pdf_url
                - output_size
            example:
              success: true
              message: "Image converted successfully"
              user_email: "user@example.com"
              storage_id: "1699876543210_aBc123XyZ.pdf"
              pdf_url: "http://minio:9000/msvc-images/1699876543210_aBc123XyZ.pdf"
              output_size: 524288
              width: 1920
              height: 1080
              original_storage_id: "1699876540000_original.png"
      responses:
        "204":
          description: Notification received and forwarded to client_svc successfully
        "400":
          description: Failed to decode ImageConversionResponse protobuf
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid request"

  /health:
    get:
      summary: Health check endpoint (GET)
      operationId: healthCheckGet
      tags:
        - health
      description: |
        Simple health check endpoint to verify service availability.

        **Controller**: user_svc/HealthController.check

        Returns 200 OK with "OK" text body.
      responses:
        "200":
          description: Service is healthy
          content:
            text/plain:
              schema:
                type: string
                example: "OK"
    head:
      summary: Health check endpoint (HEAD)
      operationId: healthCheckHead
      tags:
        - health
      description: |
        Simple health check endpoint to verify service availability without response body.

        **Controller**: user_svc/HealthController.check

        Returns 200 OK with no body.
      responses:
        "200":
          description: Service is healthy

tags:
  - name: notifications
    description: Notification endpoints for email delivery and image conversion events
  - name: health
    description: Service health check endpoints
  - name: user-management
    description: User creation and management endpoints
  - name: image-processing
    description: Image conversion and storage endpoints
  - name: storage-retrieval
    description: Endpoints for retrieving stored images from MinIO/S3

components:
  schemas:
    UserRequest:
      type: object
      description: UserRequest protobuf message for user creation
      required:
        - id
        - name
        - email
        - type
      properties:
        id:
          type: string
          description: User ID
          example: "user123"
        name:
          type: string
          description: User full name
          example: "John Doe"
        email:
          type: string
          format: email
          description: User email address
          example: "john.doe@example.com"
        type:
          type: string
          enum: [EMAIL_TYPE_WELCOME, EMAIL_TYPE_NOTIFICATION]
          description: Type of email to send
          example: "EMAIL_TYPE_WELCOME"

    UserResponse:
      type: object
      description: UserResponse protobuf message
      required:
        - ok
        - message
      properties:
        ok:
          type: boolean
          description: Success indicator
          example: true
        message:
          type: string
          description: Status message
          example: "User created successfully"

    EmailResponse:
      type: object
      description: EmailResponse protobuf message from email_svc
      required:
        - user_id
        - email
        - success
        - message
      properties:
        user_id:
          type: string
          description: User ID who received the email
          example: "user123"
        email:
          type: string
          format: email
          description: Recipient email address
          example: "john.doe@example.com"
        success:
          type: boolean
          description: Whether email was delivered successfully
          example: true
        message:
          type: string
          description: Status message or error details
          example: "Email sent successfully to john.doe@example.com"

    ImageConversionRequest:
      type: object
      description: ImageConversionRequest protobuf message
      required:
        - user_id
        - user_email
        - image_data
        - input_format
      properties:
        user_id:
          type: string
          description: User ID
          example: "user123"
        user_email:
          type: string
          format: email
          description: User email for notification
          example: "user@example.com"
        image_data:
          type: string
          format: binary
          description: Raw image binary data
        image_url:
          type: string
          format: uri
          description: URL to fetch image from (set by user_svc)
          example: "http://user_svc:8081/user_svc/image_loader/v1/1699876540000_original.png"
        input_format:
          type: string
          enum: [png, jpeg, jpg]
          description: Input image format
          example: "png"
        pdf_quality:
          type: string
          enum: [low, medium, high, lossless]
          description: PDF quality setting
          example: "high"
        strip_metadata:
          type: boolean
          description: Whether to remove EXIF metadata
          example: true
        max_width:
          type: integer
          description: Maximum width (0 for no limit)
          example: 0
        max_height:
          type: integer
          description: Maximum height (0 for no limit)
          example: 0
        storage_id:
          type: string
          description: Storage ID for the original image
          example: "1699876540000_original.png"

    ImageConversionResponse:
      type: object
      description: ImageConversionResponse protobuf message from image_svc
      required:
        - success
        - message
        - user_email
        - storage_id
        - pdf_url
        - output_size
      properties:
        success:
          type: boolean
          description: Whether conversion was successful
          example: true
        message:
          type: string
          description: Status message
          example: "Image converted successfully"
        user_email:
          type: string
          format: email
          description: Email of user who initiated conversion
          example: "user@example.com"
        storage_id:
          type: string
          description: PDF storage ID in MinIO
          example: "1699876543210_aBc123XyZ.pdf"
        pdf_url:
          type: string
          format: uri
          description: Presigned URL to access the PDF
          example: "http://minio:9000/msvc-images/1699876543210_aBc123XyZ.pdf"
        output_size:
          type: integer
          format: int64
          description: PDF file size in bytes
          example: 524288
        width:
          type: integer
          description: PDF width in pixels
          example: 1920
        height:
          type: integer
          description: PDF height in pixels
          example: 1080
        original_storage_id:
          type: string
          description: Original PNG storage ID (for cleanup)
          example: "1699876540000_original.png"
